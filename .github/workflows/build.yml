name: Build Kivy APK

on: push: branches: [ main ] workflow_dispatch:

jobs: build: name: Build APK with Buildozer runs-on: ubuntu-latest

steps:
  - name: Checkout code
    uses: actions/checkout@v3

  - name: Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: '3.10'

  - name: Install Dependencies
    run: |
      sudo dpkg --add-architecture i386
      sudo apt update
      sudo apt install -y python3-pip build-essential git zip unzip openjdk-11-jdk wget curl
      pip install --upgrade pip
      pip install --upgrade buildozer cython python-for-android

  - name: Fix NDK Version
    run: |
      mkdir -p ~/.buildozer/android/platform
      cd ~/.buildozer/android/platform
      wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
      unzip android-ndk-r25b-linux.zip
      mv android-ndk-r25b android-ndk
      echo "ANDROID_NDK_HOME=$HOME/.buildozer/android/platform/android-ndk" >> $GITHUB_ENV
      echo "ANDROID_NDK_ROOT=$HOME/.buildozer/android/platform/android-ndk" >> $GITHUB_ENV
      echo "ANDROIDNDK=$HOME/.buildozer/android/platform/android-ndk" >> $GITHUB_ENV

  - name: Install Android SDK Dependencies
    run: |
      wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
      mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
      unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
      mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
      echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
      echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
      export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
      sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-30" "build-tools;30.0.3" "platform-tools"

  - name: Set Android API Level
    run: echo "ANDROIDAPI=30" >> $GITHUB_ENV

  - name: Cleanup Before Build
    run: rm -rf .buildozer

  - name: Install Buildozer Requirements
    run: |
      sudo apt update
      sudo apt install -y \
        libncurses6 libstdc++6 libgtk2.0-0 \
        libidn12 libglu1-mesa \
        libsndfile1 libmtdev1 zlib1g-dev libffi-dev \
        libssl-dev autoconf automake libtool m4 pkg-config

  - name: Build APK
    run: buildozer -v android debug

  - name: Upload APK
    uses: actions/upload-artifact@v4
    with:
      name: kivy-apk
      path: bin/*.apk

